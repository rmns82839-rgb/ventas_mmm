<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Ventas</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            background: #2c3e50;
            color: #ecf0f1;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            position: relative;
        }
        .container {
            background-color: #34495e;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 900px;
            z-index: 10;
        }
        h1 {
            text-align: center;
            color: #ecf0f1;
            margin-bottom: 25px;
            border-bottom: 2px solid #2ecc71;
            padding-bottom: 10px;
        }
        .flex-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .total-box {
            background-color: #2c3e50;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        .total-label {
            font-size: 0.9em;
            color: #bdc3c7;
            margin-bottom: 5px;
        }
        .total-valor {
            font-size: 1.8em;
            font-weight: bold;
            color: #f1c40f;
        }
        .caja-valor { color: #2ecc71; }
        .retiros-valor { color: #e74c3c; }
        .form-group {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #bdc3c7;
        }
        input, select {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #7f8c8d;
            background-color: #2c3e50;
            color: #ecf0f1;
            outline: none;
            transition: border-color 0.3s;
        }
        input:focus, select:focus {
            border-color: #3498db;
        }
        button {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: background-color 0.3s;
            margin-top: 10px;
        }
        button:hover {
            opacity: 0.9;
        }
        /* Estilos para el registro */
        #registroVentasContainer table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        #registroVentasContainer th, #registroVentasContainer td {
            padding: 10px;
            border-bottom: 1px solid #2c3e50;
        }
        #registroVentasContainer th {
            background-color: #2c3e50;
            color: #ecf0f1;
            text-align: left;
        }
        #registroVentasContainer tr:hover {
            background-color: #44607a;
        }
        
    </style>
</head>
<body>
    <ul class="bubbles">
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
        <li></li>
    </ul>
    <div class="container">
        <h1>Control de Ventas</h1>

        <div class="flex-container">
            <div class="total-box">
                <div class="total-label">Total en Caja</div>
                <div class="total-valor caja-valor" id="totalCaja">$0.00</div>
            </div>
            <div class="total-box">
                <div class="total-label">Total Retiros</div>
                <div class="total-valor retiros-valor" id="totalRetiros">$0.00</div>
            </div>
            <div class="total-box">
                <div class="total-label">Ventas Netas</div>
                <div class="total-valor" id="totalVentasNetas">$0.00</div>
            </div>
        </div>

        <div class="flex-container" style="gap: 10px;">
            <div class="form-group">
                <label for="filtroNombreInput">Filtrar por Integrante</label>
                <input type="text" id="filtroNombreInput" placeholder="Nombre...">
            </div>
            <div class="form-group">
                <label for="filtroEstadoSelect">Filtrar por Estado</label>
                <select id="filtroEstadoSelect">
                    <option value="">Todos</option>
                    <option value="Pagado">Pagado</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="Cancelado">Cancelado</option>
                </select>
            </div>
        </div>
        
        <button id="mostrarRegistroVentasBtn" style="width: 100%; margin-bottom: 15px; background-color: #3498db;">Mostrar/Ocultar Registro de Ventas</button>
        
        <div id="registroVentasContainer" style="display: none;">
            </div>

        <div class="flex-container" style="grid-template-columns: 1fr 1fr;">
            <button id="exportarCsvBtn" style="width: 100%;">Exportar CSV</button>
            <button id="borrarDatosBtn" style="width: 100%;">Borrar Todos los Datos</button>
        </div>
        
        <div class="form-group">
            <label for="retiroCantidadInput">Retiro de Caja (Cantidad)</label>
            <div class="flex-container" style="margin-bottom: 0;">
                <input type="number" id="retiroCantidadInput" placeholder="Ej: 50.00" min="1" step="0.01">
                <input type="text" id="retiroDescripcionInput" placeholder="Motivo del retiro">
                <button onclick="agregarRetiroCaja()" style="background-color: #9b59b6; margin-top: 0;">Registrar Retiro</button>
            </div>
        </div>

        <div class="integrantes-list">
            <label style="margin-bottom: 15px; color: #f1c40f;">Gestión de Integrantes</label>
            <div class="form-group">
                <div class="flex-container" style="margin-bottom: 0;">
                    <input type="text" id="integranteNombreInput" placeholder="Nombre del nuevo integrante">
                    <button onclick="agregarIntegrante()" style="background-color: #2c3e50; margin-top: 0;">Agregar Integrante</button>
                </div>
            </div>
            <div id="integrantesContainer">
                </div>
        </div>


        <h2 style="color: #bdc3c7; text-align: center; margin-top: 25px;">Registrar Nueva Venta</h2>
        <div class="flex-container">
             <div class="form-group">
                <label for="integranteSelect">Integrante</label>
                <select id="integranteSelect">
                    </select>
            </div>
            <div class="form-group">
                <label for="productoInput">Producto</label>
                <select id="productoInput">
                    </select>
            </div>
            <div class="form-group">
                <label for="tipoValorSelect">Tipo de Registro</label>
                <select id="tipoValorSelect">
                    <option value="lista">Valor de Lista</option>
                    <option value="manual">Valor Manual</option>
                </select>
            </div>
        </div>
        
        <div class="flex-container">
            <div class="form-group" id="cantidadGroup">
                <label for="cantidadInput">Cantidad (unidades)</label>
                <input type="number" id="cantidadInput" placeholder="1" min="1" value="1">
            </div>
            <div class="form-group" id="valorManualGroup" style="display:none;">
                <label for="valorManualInput">Valor Manual ($)</label>
                <input type="number" id="valorManualInput" placeholder="Ej: 15.00" step="0.01">
            </div>
            <div class="form-group" id="descripcionManualGroup" style="display:none;">
                <label for="descripcionManualInput">Descripción (opcional)</label>
                <input type="text" id="descripcionManualInput" placeholder="Detalle de la venta">
            </div>
            <div class="form-group">
                <label for="estadoVentaSelect">Estado</label>
                <select id="estadoVentaSelect">
                    <option value="Pagado">Pagado</option>
                    <option value="Pendiente">Pendiente</option>
                    <option value="Cancelado">Cancelado</option>
                </select>
            </div>
        </div>

        <button onclick="agregarVenta()" style="background-color: #3498db; width: 100%; margin-top: 15px;">Registrar Venta</button>
        

    </div>

    <div id="passwordModal" class="modal">
        </div>
    
    <script>
        // CRÍTICO: ¡DEBES PEGAR AQUÍ LA URL REAL DE TU WEB SERVICE DE RENDER!
        const API_BASE_URL = 'https://ventas-mmm.onrender.com'; 

        // --- Datos de Configuración Local ---
        const ventasPorDefecto = [
            { nombre: 'Producto A', valor: 10.50 },
            { nombre: 'Producto B', valor: 25.00 },
            { nombre: 'Producto C', valor: 5.00 },
        ];
        const claveSeguridad = "1234"; 
        let integrantes = ['Ivan']; 

        // --- Funciones de Lógica y UI (Ajustadas para la API) ---

        // Función para enviar una solicitud al backend
        async function fetchAPI(endpoint, method = 'GET', data = null) {
            try {
                const url = `${API_BASE_URL}${endpoint}`;
                const options = {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: data ? JSON.stringify(data) : null,
                };

                const response = await fetch(url, options);
                
                if (response.ok) {
                    return method === 'DELETE' ? true : response.json(); 
                } else {
                    const errorText = await response.text();
                    let errorMessage = 'Error desconocido del servidor.';
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage = errorData.message || errorMessage;
                    } catch (e) {
                        errorMessage = `Error ${response.status}: ${errorText || 'Error de red o servidor'}`;
                    }
                    mostrarMensaje(`Error ${method} ${endpoint}: ${errorMessage}`, 'error');
                    // Si falla, retornamos un array vacío para que no rompa el renderizado
                    return endpoint.includes('/ventas') || endpoint.includes('/retiros') ? [] : null; 
                }
            } catch (error) {
                console.error('Fallo de conexión:', error);
                mostrarMensaje(`Fallo de conexión: El servidor (${API_BASE_URL}) no está disponible o la URL es incorrecta.`, 'error');
                // Si falla la conexión, retornamos un array vacío
                return endpoint.includes('/ventas') || endpoint.includes('/retiros') ? [] : null; 
            }
        }
        
        function mostrarMensaje(mensaje, tipo) {
            console.log(`${tipo.toUpperCase()}: ${mensaje}`);
            alert(mensaje); 
        }

        // --- Lógica de la Venta (Utiliza el endpoint POST /api/ventas) ---
        
        async function agregarVenta() {
            const integrante = document.getElementById('integranteSelect').value;
            const productoSelect = document.getElementById('productoInput');
            const productoNombre = productoSelect.options[productoSelect.selectedIndex].text; 
            const tipoValor = document.getElementById('tipoValorSelect').value;
            const estado = document.getElementById('estadoVentaSelect').value;
            
            let valor, descripcion;

            if (tipoValor === 'manual') {
                valor = parseFloat(document.getElementById('valorManualInput').value) || 0;
                descripcion = document.getElementById('descripcionManualInput').value || 'Venta manual';
            } else {
                const cantidad = parseInt(document.getElementById('cantidadInput').value) || 1;
                const productoElegido = ventasPorDefecto.find(p => p.nombre === productoSelect.value);
                
                if (!productoElegido) { mostrarMensaje("Producto no válido.", 'error'); return; }
                
                valor = productoElegido.valor * cantidad;
                descripcion = `Venta de ${cantidad} x ${productoElegido.nombre}`;
            }

            if (!integrante || !valor || valor <= 0) {
                mostrarMensaje('Por favor, completa todos los campos requeridos (Integrante y Valor > 0).', 'error');
                return;
            }

            const ventaData = {
                nombre: integrante, 
                valor: valor,
                fecha: new Date().toISOString(),
                estado: estado,
                descripcion: descripcion,
                producto: productoNombre 
            };

            const nuevaVenta = await fetchAPI('/api/ventas', 'POST', ventaData);

            if (nuevaVenta) {
                mostrarMensaje('Venta registrada con éxito.', 'success');
                actualizarUI(); 
            }
        }
        
        // --- Lógica del Retiro (Utiliza el endpoint POST /api/retiros) ---

        async function agregarRetiroCaja() {
            const cantidad = parseFloat(document.getElementById('retiroCantidadInput').value);
            const descripcion = document.getElementById('retiroDescripcionInput').value;

            if (!cantidad || cantidad <= 0 || !descripcion) {
                mostrarMensaje("Por favor, introduce una cantidad válida y el motivo del retiro.", 'error');
                return;
            }

            const retiroData = { cantidad, descripcion, fecha: new Date().toISOString() };

            const nuevoRetiro = await fetchAPI('/api/retiros', 'POST', retiroData);

            if (nuevoRetiro) {
                mostrarMensaje('Retiro registrado con éxito en MongoDB.', 'success');
                document.getElementById('retiroCantidadInput').value = '';
                document.getElementById('retiroDescripcionInput').value = '';
                actualizarUI(); 
            }
        }

        // --- Lógica de Visualización y Totales (Utiliza GET) ---
        
        function calcularTotales(ventas, retiros) {
            const totalVentasPagadas = ventas
                .filter(v => v.estado === 'Pagado')
                .reduce((sum, v) => sum + v.valor, 0);

            const totalRetiros = retiros.reduce((sum, r) => sum + r.cantidad, 0);

            const totalCaja = totalVentasPagadas;
            const totalVentasNetas = totalCaja - totalRetiros;

            return { totalCaja, totalRetiros, totalVentasNetas };
        }

        function renderRegistroVentas(ventas, retiros) {
            const container = document.getElementById('registroVentasContainer');
            
            const movimientos = [
                ...ventas.map(v => ({
                    tipo: 'Venta', 
                    descripcion: v.descripcion || `${v.producto} (${v.estado})`, 
                    valor: v.valor,
                    fecha: new Date(v.fecha),
                    estado: v.estado
                })),
                ...retiros.map(r => ({
                    tipo: 'Retiro', 
                    descripcion: r.descripcion, 
                    valor: r.cantidad,
                    fecha: new Date(r.fecha),
                    estado: 'Retiro'
                }))
            ].sort((a, b) => b.fecha - a.fecha);

            if (movimientos.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #7f8c8d; padding: 20px;">No hay movimientos registrados.</p>';
                return;
            }

            let html = `<table style="width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9em;"><thead style="background-color: #34495e;"><tr><th style="padding: 10px; text-align: left;">Tipo</th><th style="padding: 10px; text-align: left;">Descripción</th><th style="padding: 10px; text-align: right;">Valor ($)</th><th style="padding: 10px; text-align: center;">Estado</th><th style="padding: 10px; text-align: center;">Fecha</th></tr></thead><tbody>`;

            movimientos.forEach(m => {
                const valorDisplay = m.tipo === 'Retiro' ? `-$${m.valor.toFixed(2)}` : `$${m.valor.toFixed(2)}`;
                const color = m.tipo === 'Retiro' ? '#e74c3c' : m.estado === 'Pagado' ? '#2ecc71' : '#f1c40f';
                const estadoDisplay = m.tipo === 'Retiro' ? 'COMPLETADO' : m.estado;
                
                html += `<tr style="border-bottom: 1px solid #34495e;"><td style="padding: 10px;">${m.tipo}</td><td style="padding: 10px;">${m.descripcion}</td><td style="padding: 10px; text-align: right; color: ${color}; font-weight: bold;">${valorDisplay}</td><td style="padding: 10px; text-align: center;">${estadoDisplay}</td><td style="padding: 10px; text-align: center;">${m.fecha.toLocaleDateString()} ${m.fecha.toLocaleTimeString()}</td></tr>`;
            });

            html += `</tbody></table>`;
            container.innerHTML = html;
        }


        async function actualizarUI() {
             // Llama a la API para obtener las ventas y retiros
             const ventas = await fetchAPI('/api/ventas', 'GET');
             const retiros = await fetchAPI('/api/retiros', 'GET'); 

             // Si la API no respondió correctamente (devuelve array vacío por defecto si falla)
             if (!Array.isArray(ventas) || !Array.isArray(retiros)) { 
                 console.log("No se pudieron obtener datos del backend. Verifique la URL y el estado del Web Service.");
                 return; 
             }

             const { totalCaja, totalRetiros, totalVentasNetas } = calcularTotales(ventas, retiros);

             document.getElementById('totalCaja').textContent = `$${totalCaja.toFixed(2)}`;
             document.getElementById('totalRetiros').textContent = `$${totalRetiros.toFixed(2)}`;
             document.getElementById('totalVentasNetas').textContent = `$${totalVentasNetas.toFixed(2)}`;
             
             renderRegistroVentas(ventas, retiros);
        }
        
        // --- Otras funciones de UI ---
        
        function renderIntegrantes() {
            const select = document.getElementById('integranteSelect');
            select.innerHTML = '';
            integrantes.forEach(nombre => {
                const option = document.createElement('option');
                option.value = nombre;
                option.textContent = nombre;
                select.appendChild(option);
            });
            if (integrantes.length === 0) {
                 select.innerHTML = '<option value="">(Agregue un integrante)</option>';
            }
            
            const container = document.getElementById('integrantesContainer');
            container.innerHTML = `<div>Integrante por defecto: **${integrantes[0]}**</div><div style="font-size: 0.8em; color: #7f8c8d;">(La gestión completa de integrantes está pendiente)</div>`;
        }
        
        function inicializarProductos() {
             const productoInput = document.getElementById('productoInput');
             productoInput.innerHTML = '';
             ventasPorDefecto.forEach(p => {
                 const option = document.createElement('option');
                 option.value = p.nombre;
                 option.textContent = `${p.nombre} ($${p.valor.toFixed(2)})`;
                 productoInput.appendChild(option);
             });
        }
        
        // Las funciones agregarIntegrante, exportarCSV y la lógica del modal de contraseña necesitan el backend completo
        function agregarIntegrante() {
            mostrarMensaje("Función de Integrante: Necesita un endpoint POST /api/integrantes en el Backend.", 'info');
        }

        function exportarCSV() {
            mostrarMensaje("Función Exportar CSV: Necesita un endpoint GET /api/exportar en el Backend.", 'info');
        }
        
        // --- EVENTOS DE INICIALIZACIÓN ---

        document.addEventListener('DOMContentLoaded', () => {
            
            // Botón Mostrar/Ocultar Registro
            document.getElementById('mostrarRegistroVentasBtn').addEventListener('click', () => {
                const container = document.getElementById('registroVentasContainer');
                container.style.display = container.style.display === 'none' ? 'block' : 'none';
            });
            
            // Lógica de Venta Manual vs Lista
            const tipoValorSelect = document.getElementById('tipoValorSelect');
            const cantidadGroup = document.getElementById('cantidadGroup');
            const valorManualGroup = document.getElementById('valorManualGroup');
            const descripcionManualGroup = document.getElementById('descripcionManualGroup');
            
            tipoValorSelect.addEventListener('change', () => {
                if (tipoValorSelect.value === 'manual') {
                    cantidadGroup.style.display = 'none';
                    valorManualGroup.style.display = 'block';
                    descripcionManualGroup.style.display = 'block';
                } else {
                    cantidadGroup.style.display = 'block';
                    valorManualGroup.style.display = 'none';
                    descripcionManualGroup.style.display = 'none';
                }
            });
            tipoValorSelect.dispatchEvent(new Event('change')); // Ejecutar al inicio

            // Borrar datos (placeholder)
            document.getElementById('borrarDatosBtn').addEventListener('click', () => {
                // Aquí se abriría el modal y luego se llamaría a DELETE /api/datos-completos
                mostrarMensaje("Borrado de Datos: Necesita un endpoint DELETE en el Backend para borrar datos de MongoDB.", 'info');
            });


            // Inicialización final
            inicializarProductos();
            renderIntegrantes();
            actualizarUI(); // Carga de datos reales
        });
    </script>
</body>
</html>
